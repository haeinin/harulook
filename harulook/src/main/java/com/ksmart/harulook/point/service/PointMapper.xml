<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.ksmart.harulook.point.service.PointMapper">
     
    <resultMap type="com.ksmart.harulook.point.service.PointDto" id="Point">
		<result property="pointPolicyNo" column="point_policy_no"/>
		<result property="pointPolicyValue" column="point_policy_value"/>
		<result property="pointPolicyReason" column="point_policy_reason"/>
		<result property="pointNo" column="point_no"/>
		<result property="userId" column="user_id"/>
		<result property="pointDate" column="point_date"/>
		<result property="pointGoodsCode" column="point_goods_code"/>
	</resultMap>
	
	<!-- 쿠폰 중복 검사 -->
   	<select id="couponCheck" parameterType="java.util.Map" resultType="String">
		select point_goods_code
		from point
		where point_goods_code = #{pointGoodsCode}
		;
	</select>
	
	<!-- 쿠폰 사용 -->
   	<select id="couponInset" parameterType="java.util.Map" >
		INSERT INTO point (
			point_no
			,user_id
			,point_date
			,point_policy_no
			,point_goods_code
			)
		VALUES (
			#{pointNo}
			,#{userId}
			,DATE(NOW())
			,(select point_policy_no
			from point_policy
			where point_policy_value = #{pointPolicyValue})
			,#{pointGoodsCode}
		);
   	</select>
	
	<!-- 포인트 사용 취득 내역 번호 -->
   	<select id="pointNo" resultType="String">
		select MAX(CAST(substring(point_no, 7) AS DECIMAL))
		from point
		;
   	</select>
	
	
	<!-- 나의 포인트 -->
   	<select id="myPoint" parameterType="java.util.Map" resultType="int">
		select sum(point_policy.point_policy_value) point_policy_value
		from point
		join point_policy
		on point.point_policy_no = point_policy.point_policy_no
		where point.user_id = #{userId}
		;
	</select>	
	
	<!-- 포인트 사용 내역 -->
   	<select id="pointUse" parameterType="java.util.Map" resultMap="Point">
		select point.point_no
			, point.point_date
			, point.point_policy_no
			, point.point_goods_code
			, point_policy.point_policy_reason
			, point_policy.point_policy_value
		from point
		join point_policy
		on point.point_policy_no = point_policy.point_policy_no
		where point.user_id = #{userId} 
		and point_policy.point_policy_value &lt; 0 
		order by point.point_date desc
		;
	</select>
	
	<!-- 포인트 취득 내역 -->
   	<select id="pointGet" parameterType="java.util.Map" resultMap="Point">
		select point.point_no
			, point.point_date
			, point.point_policy_no
			, point_policy.point_policy_reason
			, point_policy.point_policy_value
		from point
		join point_policy
		on point.point_policy_no = point_policy.point_policy_no
		where point.user_id = #{userId} 
		and point_policy.point_policy_value > 0 
		order by point.point_date desc
		;
	</select>
	
	<!-- 포인트 쿠폰 정책 -->
   	<select id="pointUsePolicy" parameterType="java.util.Map" resultMap="Point">
		select point_policy_no
			, point_policy_value
			, point_policy_reason
		from point_policy
		Where point_policy_value &lt; 0 
		order by point_policy_value desc 
		;
	</select>	
	
	<!-- 포인트 정책 리스트 -->
   	<select id="pointPolicy" parameterType="java.util.Map" resultMap="Point">
		select point_policy_no
			, point_policy_value
			, point_policy_reason
		from point_policy
		Where point_policy_value > 0
		order by point_policy_value desc 
		;
	</select>	
	
</mapper>


