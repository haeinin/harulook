<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ksmart.harulook.hof.service.HofMapper">

	<resultMap type="com.ksmart.harulook.hof.service.HofDto" id="hof">
		<result property="hofMonth" column="hof_month"></result>
		<result property="boardNo" column="sns_board_no"></result>
		<result property="hofDate" column="hof_date"></result>
		<result property="hofRank" column="hof_rank"></result>
		<result property="pointPolicyNo" column="point_policy_no"></result>
		<result property="hofPrizeStat" column="hof_prize_stat"></result>
	</resultMap>
	
	<resultMap type="com.ksmart.harulook.hof.service.HofRankDto" id="hofRank">
		<result property="boardNo" column="sns_board_no"></result>
		<result property="rank" column="rank"></result>
		<result property="liker" column="liker"></result>
	</resultMap>
	
	<!-- 이번 달 명예의전당 -->
	<select id="getHofList" resultMap="hof">
	SELECT 
		hof_month
		,hof_rank
		,sns_board_no
	FROM 
		hof
	WHERE 
		MONTH(hof_date) = MONTH(NOW())	
	</select>
	
	<!-- 이번 달 좋아요 랭크 보기 -->
	<select id = "getBoardLikeRank" resultMap="hofRank">
	SELECT 
		sns_board_no, 
		CASE
		WHEN @prev = liker then @Rank 
		WHEN @prev := liker then @Rank := @Rank +1 
		END AS rank, 
		liker
	FROM 
		(
		SELECT sns_board_no ,count(sns_like_no) as liker
		FROM sns_like
		WHERE MONTH(sns_like_date) = MONTH(NOW())
		GROUP BY sns_board_no 
		ORDER BY count(sns_like_no) DESC
		)sub1
	CROSS JOIN (select @Rank := 0 ,@prev :=  NULL) sub2
	;
	</select>
	
	<!-- 이번달 명예의전당 입력처리 -->
	<insert id="insertHof" parameterType="com.ksmart.harulook.hof.service.HofDto">
	INSERT INTO hof
	(
	 hof_month
	,hof_rank
	,sns_board_no
	,hof_date
	,point_policy_no
	)
	VALUES 
	(
	(MONTH(NOW())-1)
	,#{hofRank}
	,#{boardNo}
	,DATE(NOW())
	,#{pointPolicyNo}
	)
	</insert>
	
	<!-- 명예의전당 중복체크 -->
	<select id="dupliacteHof" resultType="int">
	SELECT 
		COUNT(sns_board_no)
	FROM 
		hof
	WHERE 
		sns_board_no=#{boardNo}
	
	</select>
	
	<insert id="test" parameterType="String">
	INSERT INTO hof
	(hof_month, hof_rank, sns_board_no, hof_date)
	VALUES (1, 1, '1', date(NOW()))
	
	</insert>
	
	
	
	
	</mapper>