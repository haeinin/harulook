<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ksmart.harulook.partner.service.PartnerMapper">

	<resultMap type="com.ksmart.harulook.partner.service.PartnerDto" id="partner">
		<result property="cooContractNo" column="coo_contract_no"></result>
		<result property="userId" column="user_id"></result>
		<result property="managerId" column="manager_id"></result>
		<result property="cooContractDc" column="coo_contract_dc"></result>
		<result property="cooContractFee" column="coo_contract_fee"></result>
		<result property="cooContractStart" column="coo_contract_start"></result>
		<result property="cooContractEnd" column="coo_contract_end"></result>
		<result property="cooContractDate" column="coo_contract_date"></result>
		<result property="cooContractPayDay" column="coo_contract_pay_date"></result>
		<result property="cooContractCode" column="coo_contract_code"></result>
		<result property="cooContractImg" column="coo_contract_img"></result>
		<result property="cooContractLink" column="coo_contract_link"></result>
		<result property="cooContractStat" column="coo_contract_stat"></result>
		<result property="cooContractPayStat" column="coo_contract_pay_stat"></result>
	</resultMap>
	<resultMap type="com.ksmart.harulook.partner.service.PartnerBillDto" id="partnerBill">
		<result property="cooBillNo" column="coo_bill_no"></result>
		<result property="cooContractNo" column="coo_contract_no"></result>
		<result property="cooBillValue" column="coo_bill_value"></result>
		<result property="cooBillMonth" column="coo_bill_month"></result>
		<result property="cooBillDate" column="coo_bill_date"></result>
	</resultMap>
	<resultMap type="com.ksmart.harulook.partner.service.PartnerPayDto" id="partnerPay">
		<result property="cooPayNo" column="coo_pay_no"></result>
		<result property="cooContractNo" column="coo_contract_no"></result>
		<result property="cooPayDate" column="coo_pay_date"></result>
		<result property="cooPayTotal" column="coo_pay_total"></result>

	</resultMap>


	<!-- 제휴계약신청 -->
	<insert id="cooContractInsert" parameterType="com.ksmart.harulook.partner.service.PartnerDto">
		INSERT INTO
		coo_contract(
		coo_contract_no
		,user_id
		,manager_id
		,coo_contract_dc
		,coo_contract_fee
		,coo_contract_start
		,coo_contract_end
		,coo_contract_date
		,coo_contract_pay_date
		,coo_contract_code
		,coo_contract_img
		,coo_contract_link
		,coo_contract_stat
		,coo_contract_pay_stat
		)
		VALUES (
		#{cooContractNo}
		,#{userId}
		,#{managerId}
		,#{cooContractDc}
		,#{cooContractFee}
		,#{cooContractStart}
		,#{cooContractEnd}
		,date(now())
		,#{cooContractPayDay}
		,#{cooContractCode}
		,#{cooContractImg}
		,#{cooContractLink}
		,'제휴신청'
		,'결제대기'

		)
	</insert>
	<!-- 제휴계약번호 가져오기 -->
	<select id="getLastCooContractNo" resultType="String">
		SELECT
		max(CAST(substring(coo_contract_no,13) AS DECIMAL))
		FROM coo_contract
	</select>


	<!-- 제휴계약 목록보기 -->
	<select id="cooContractList" resultMap="partner">
		SELECT
		coo_contract_no
		,user_id
		,manager_id
		,coo_contract_dc
		,coo_contract_fee
		,coo_contract_start
		,coo_contract_end
		,coo_contract_date
		,coo_contract_pay_date
		,coo_contract_code
		,coo_contract_img
		,coo_contract_link
		,coo_contract_stat
		,coo_contract_pay_stat
		FROM
		coo_contract

	</select>

	<!-- 제휴계약 상세보기 -->
	<select id="cooContractDetail" parameterType="String" resultMap="partner">
		SELECT
		coo_contract_no
		, user_id
		, manager_id
		, coo_contract_dc
		,coo_contract_fee
		,coo_contract_start
		, coo_contract_end
		,coo_contract_date
		,coo_contract_pay_date
		, coo_contract_code
		,coo_contract_img
		,coo_contract_link
		, coo_contract_stat
		,coo_contract_pay_stat
		FROM
		coo_contract
		WHERE
		coo_contract_no=#{cooContractNo}
	</select>
	<!-- 제휴계약 수정 -->
	<update id="cooContractUpdate" parameterType="com.ksmart.harulook.partner.service.PartnerDto">
		UPDATE
		coo_contract
		SET
		coo_contract_dc=#{cooContractDc}
		,coo_contract_fee=#{cooContractFee}
		,coo_contract_start=#{cooContractStart}
		,coo_contract_end=#{cooContractEnd}
		,coo_contract_pay_date=#{cooContractPayDay}
		,coo_contract_img=#{cooContractImg}
		,coo_contract_link=#{cooContractLink}
		,coo_contract_stat='수정신청'
		WHERE
		coo_contract_no=#{cooContractNo}
	</update>
	
	<!-- 제휴 결제 처리 -->
	<insert id="cooContractPayinsert" parameterType="com.ksmart.harulook.partner.service.PartnerBillDto">
		INSERT INTO coo_pay
		(
		coo_contract_no
		, coo_pay_date
		,coo_pay_total
		)
		VALUES 
		( 
		#{cooContractNo}
		, DATE(NOW())
		,	(
			SELECT 
				coo_bill_value
			FROM 
				coo_bill 
			WHERE 
				coo_bill_no = #{coo_bill_no}
			)
		)
	</insert>
	<!-- 제휴결제처리 후 제휴예정데이터 삭제 -->
	<delete id="cooContractBillDelete" parameterType="com.ksmart.harulook.partner.service.PartnerBillDto">
		DELETE 
		FROM coo_bill 
		WHERE coo_bill_no = #{coo_bill_no}
	</delete>
	<!-- 제휴 결제상태 변경 -->
	<update id="cooContractPayStatUpdate" parameterType="com.ksmart.harulook.partner.service.PartnerBillDto">
		UPDATE
		coo_contract
		SET 
		coo_contract_pay_stat = '결제완료'
		WHERE 
		coo_contract_no = 
					(
					SELECT 
						distinct coo_pay.coo_contract_no
					FROM 
						coo_pay
					JOIN 
						coo_bill
					ON
						coo_bill.coo_contract_no = coo_pay.coo_contract_no
					WHERE (coo_pay.coo_pay_total - coo_bill.coo_bill_value)>=0 
					AND coo_pay.coo_contract_no = #{cooContractNo})

	</update>
	
	<!-- 제휴 업체 상세보기 -->
	
	<!-- 제휴 수수료 계산 -->
	<insert id="cooContractBillInsert" parameterType="com.ksmart.harulook.partner.service.PartnerBillDto">
		INSERT INTO coo_bill
		(
		coo_bill_no
		,coo_contract_no
		,coo_bill_value
		,coo_bill_month
		,coo_bill_date
		)
		VALUES
		(
		#{cooBillNo}
		,#{cooContractNo}
		,(
			SELECT
				SUM(mall_sale.mall_sale_total)
			FROM 
				mall_sale
			JOIN 
				coo_contract
			ON 
				coo_contract.coo_contract_code = mall_sale.coo_contract_code
			WHERE
				coo_contract.coo_contract_no = #{cooContractNo}
			AND
				MONTH(mall_sale_date)=(MONTH(NOW())-1)
		)
		,(MONTH(NOW())-1)
		,(
			SELECT
				DATE_ADD(DATE_SUB(DATE(NOW()) ,interval DAY(NOW()) day),interval coo_contract_pay_date day)
			FROM 
				coo_contract
			WHERE
				coo_contract_no=#{cooContractNo}
			)
		);
	</insert>


	<!-- 제휴 결제예정 금액 조회 -->
	<select id="cooContractBill" parameterType="String" resultMap="partnerBill">
		SELECT
		coo_bill_no
		,coo_contract_no
		,coo_bill_value
		,coo_bill_month
		,coo_bill_date
		FROM
		coo_bill
		WHERE coo_contract_no = #{cooContractNo}
	</select>

	<!-- 제휴신청 승인 -->
	<update id="cooContractAdmit" parameterType="com.ksmart.harulook.partner.service.PartnerDto">
		UPDATE
		coo_contract
		SET
		manager_id=#{managerId}
		,coo_contract_stat='제휴승인'
		WHERE
		coo_contract_no = #{cooContractNo}

	</update>
	
	<!-- 제휴결제내역보기 -->
	<select id="cooContractPayList" parameterType="String" resultMap="partnerPay">
		SELECT 
		coo_contract_no
		,coo_pay_date
		,coo_pay_total
		FROM 
		coo_pay
		WHERE 
		coo_contract_no = #{cooContracNo}
	</select>




</mapper>